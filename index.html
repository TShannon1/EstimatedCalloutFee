<script>
  const origin = "Hazelmere WA 6055";
  const freeDistanceKm = 2;
  const ratePerKm = 1.30;
  const minCalloutFee = 15;
  const maxCalloutFee = 150;

  function roundUpToNearest5(value) {
    return Math.ceil(value / 5) * 5;
  }

  function calculateTravelCost() {
    const destination = document.getElementById("destination").value.trim();
    const resultDiv = document.getElementById("result");
    const loader = document.getElementById("loader");

    resultDiv.innerText = "";
    loader.innerText = "Calculating... Please wait.";

    if (!destination) {
      loader.innerText = "";
      resultDiv.innerText = "Please enter a valid suburb or postcode.";
      return;
    }

    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({ address: destination }, function(geoResults, geoStatus) {
      if (geoStatus !== "OK" || !geoResults || geoResults.length === 0) {
        loader.innerText = "";
        resultDiv.innerText = "Unable to determine the location. Please check the address and try again.";
        return;
      }

      const components = geoResults[0].address_components;
      const stateComponent = components.find(c => c.types.includes("administrative_area_level_1"));
      const stateShortName = stateComponent ? stateComponent.short_name : "";

      if (stateShortName !== "WA") {
        loader.innerText = "";
        resultDiv.innerText = "Destination is outside Western Australia. Please contact tony@tonystechsupport.com for a quote.";
        return;
      }

      const service = new google.maps.DistanceMatrixService();
      service.getDistanceMatrix({
        origins: [origin],
        destinations: [destination],
        travelMode: google.maps.TravelMode.DRIVING,
        unitSystem: google.maps.UnitSystem.METRIC
      }, function(response, status) {
        loader.innerText = "";

        if (
          status !== google.maps.DistanceMatrixStatus.OK ||
          !response.rows[0].elements[0].distance ||
          response.rows[0].elements[0].status !== "OK"
        ) {
          resultDiv.innerText = "Sorry, we couldn't calculate the fee. Please check the suburb and try again.";
          return;
        }

        const distanceValue = response.rows[0].elements[0].distance.value;
        const distanceKm = distanceValue / 1000;
        const roundTripKm = distanceKm * 2;

        console.log(`[DEBUG] One-way distance: ${distanceKm.toFixed(2)} km`);
        console.log(`[DEBUG] Round-trip: ${roundTripKm.toFixed(2)} km`);

        if (roundTripKm <= freeDistanceKm) {
          resultDiv.innerText = "Estimated Callout Fee: $0 (You're in the free callout area)";
        } else {
          const rawCost = roundTripKm * ratePerKm;
          const roundedCost = roundUpToNearest5(rawCost);
          const finalCost = Math.max(minCalloutFee, Math.min(roundedCost, maxCalloutFee));

          console.log(`[DEBUG] Raw cost: $${rawCost.toFixed(2)}`);
          console.log(`[DEBUG] Rounded: $${roundedCost}`);
          console.log(`[DEBUG] Final callout fee: $${finalCost}`);

          resultDiv.innerText = `Estimated Callout Fee: $${finalCost}`;
        }
      });
    });
  }

  function initAutocomplete() {
    const input = document.getElementById("destination");
    const autocomplete = new google.maps.places.Autocomplete(input, {
      types: ["(regions)"]
    });
    autocomplete.setComponentRestrictions({ country: ["au"] });
  }
</script>
